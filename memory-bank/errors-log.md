# Errors Log — что пошло не так и как решили

## Формат записи
### [ДАТА] Короткое название ошибки
- **Симптом:** что наблюдалось
- **Причина:** почему произошло
- **Решение:** что сделали
- **Правило:** как избежать в будущем

---

## Зафиксированные ошибки

### [2026-02] PostgreSQL порт
- **Симптом:** подключение к БД падало
- **Причина:** стандартный порт 5432 вместо 5433
- **Решение:** исправить DATABASE_URL на порт 5433
- **Правило:** PostgreSQL всегда на 5433 в этом проекте

---

### [2026-02] WhaleDetector AttributeError — self.config не сохранялся
- **Симптом:** контейнер whale-detector падал сразу после запуска
- **Причина:** в whale_detector.py `__init__` принимал `config` но не делал `self.config = config`
- **Решение:** добавить `self.config = config` в `__init__` после строки 148
- **Правило:** при создании класса всегда проверять что все параметры `__init__` сохраняются в `self`

---

### [2026-02-28] Whale Stats Incorrect — win_rate и profit были некорректны

#### Проблема 1: Некорректный win_rate
- **Симптом:** win_rate показывал процент от всех сделок кита (buy сделки)
- **Причина:** Считалось что "buy" = "win", но это не так! Покупка "Yes" - это просто позиция, не выигрыш
- **Решение:**
  - Введён `stats_mode: REALIZED` - статистика основана на реальных результатах копирования
  - win_rate теперь вычисляется как: realized_pnl > 0 / total_copied_trades
  - Используется realized_pnl из скопированных сделок в БД
- **Правило:** Не путать buy сделку с выигрышем. Win = позиция закрылась с прибылью

#### Проблема 2: Некорректный profit
- **Симптом:** profit показывал volume, а не реальную прибыль
- **Причина:** API не предоставляет PnL, использовался volume как прокси
- **Решение:**
  - profit теперь = realized_pnl из скопированных сделок
  - Добавлено поле `data_capability: PARTIAL` в PROJECT_STATE
- **Правило:** Не использовать volume как замену profit

#### Проблема 3: Разные risk_score в detector и tracker
- **Симптом:** risk_score вычислялся в двух местах с разной логикой
- **Причина:** Не было единого source-of-truth
- **Решение:**
  - risk_score_source_of_truth: tracker
  - whale_detector использует risk_score из whale_tracker
  - Единая логика в QUALITY_WHALE_CRITERIA
- **Правило:** Всегда иметь единый source-of-truth для ключевых метрик

#### Проблема 4: API Capability
- **Симптом:** Ожидали от API данные, которых нет
- **Причина:** Polymarket Data API НЕ предоставляет: direct PnL, win/loss статус сделок
- **Решение:**
  - Добавлен аудит в docs/data_capability_audit.md
  - data_capability: PARTIAL
  - stats_mode: REALIZED (только при копировании получаем реальные результаты)
- **Правило:** Всегда проверять фактические возможности API перед использованием
